#!/bin/bash

# Pre-push hook: Ensure CHANGELOG is updated for version changes
# This checks if package.json version differs from last pushed version
# and verifies that CHANGELOG.md or version-specific files have been updated

# Get the current version
CURRENT_VERSION=$(grep '"version"' package.json | head -1 | sed -E 's/.*"version":\s*"([^"]+)".*/\1/')

# Get list of commits to be pushed
COMMITS_TO_PUSH=$(git rev-list @{u}..HEAD 2>/dev/null | wc -l)

# If no commits to push, exit successfully
if [ "$COMMITS_TO_PUSH" -eq 0 ]; then
  exit 0
fi

echo "üß™ Running tests..."
if ! npm test; then
  echo "‚ùå Tests failed. Push aborted."
  exit 1
fi

# Check if any SCSS files changed in commits to push
SCSS_CHANGED=$(git log @{u}..HEAD --name-only --pretty=format: | grep -q '\.scss$' && echo 1 || echo 0)

if [ "$SCSS_CHANGED" -eq 1 ]; then
  # Check if package.json version was already manually updated
  VERSION_MANUALLY_UPDATED=$(git log @{u}..HEAD --name-only --pretty=format: | grep -q 'package.json' && echo 1 || echo 0)
  
  if [ "$VERSION_MANUALLY_UPDATED" -eq 0 ]; then
    # Get current version
    CURRENT_VERSION=$(grep '"version"' package.json | head -1 | sed -E 's/.*"version":\s*"([^"]+)".*/\1/')
    
    echo ""
    echo "üì¶ SCSS files changed in commits to push"
    echo "Current version: $CURRENT_VERSION"
    echo ""
    
    # Interactive version bump prompt
    BUMP_TYPE="skip"
    if [ -t 1 ]; then
      exec < /dev/tty
      echo -e "Choose version bump: (p)atch, (m)inor, (M)ajor, (s)kip [default] > \c"
      read -r choice
      case "$choice" in
        p|patch) BUMP_TYPE="patch" ;;
        m|minor) BUMP_TYPE="minor" ;;
        M|Major) BUMP_TYPE="major" ;;
        *)       BUMP_TYPE="skip" ;;
      esac
    fi
    
    if [ "$BUMP_TYPE" != "skip" ]; then
      # Parse version parts
      MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
      MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
      PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)
      
      if [ "$BUMP_TYPE" == "major" ]; then
        NEW_MAJOR=$((MAJOR + 1))
        NEW_VERSION="$NEW_MAJOR.0.0"
      elif [ "$BUMP_TYPE" == "minor" ]; then
        NEW_MINOR=$((MINOR + 1))
        NEW_VERSION="$MAJOR.$NEW_MINOR.0"
      else
        NEW_PATCH=$((PATCH + 1))
        NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
      fi
      
      echo ""
      echo "üìù Bumping version ($BUMP_TYPE): $CURRENT_VERSION ‚Üí $NEW_VERSION"
      
      # Update package.json
      sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$NEW_VERSION\"/" package.json
      
      # Update version in HTML and documentation files
      bash project/scripts/update-version.sh
      
      # Commit the version bump
      git add package.json index.html docs/index.html docs/getting-started.md
      git commit -m "chore: bump version to v$NEW_VERSION"
      
      echo "‚úÖ Version bumped to v$NEW_VERSION and committed"
      echo ""
      echo "‚ö†Ô∏è  Remember to update CHANGELOG.md or create project/docs/changelog/v$NEW_VERSION.md"
      echo "   Then amend the commit: git commit --amend --no-edit"
      echo ""
    fi
  fi
fi

echo "üìã Pre-push validation: Checking changelog..."
echo "Current version: $CURRENT_VERSION"

# Check if CHANGELOG.md has been modified in commits to push
if git log @{u}..HEAD --name-only --pretty=format: | grep -q "CHANGELOG.md"; then
  echo "‚úÖ CHANGELOG.md updated in commits to push"
  CHANGELOG_UPDATED=1
else
  CHANGELOG_UPDATED=0
fi

# Check if any version-specific changelog files have been updated
if git log @{u}..HEAD --name-only --pretty=format: | grep -q "project/docs/changelog/"; then
  echo "‚úÖ Version changelog file updated in commits to push"
  VERSION_FILE_UPDATED=1
else
  VERSION_FILE_UPDATED=0
fi

# If version changed in commits, changelog must be updated
VERSION_CHANGED=$(git log @{u}..HEAD --name-only --pretty=format: | grep -q "package.json" && echo 1 || echo 0)

if [ "$VERSION_CHANGED" -eq 1 ]; then
  if [ "$CHANGELOG_UPDATED" -eq 0 ] && [ "$VERSION_FILE_UPDATED" -eq 0 ]; then
    echo ""
    echo "‚ùå Error: Version changed but CHANGELOG not updated!"
    echo ""
    echo "You must update one of the following:"
    echo "  1. CHANGELOG.md - Main changelog overview"
    echo "  2. project/docs/changelog/v${CURRENT_VERSION}.md - Version-specific changelog"
    echo ""
    echo "Example: Create project/docs/changelog/v${CURRENT_VERSION}.md with release notes"
    echo ""
    echo "Then run:"
    echo "  git add CHANGELOG.md (or project/docs/changelog/v${CURRENT_VERSION}.md)"
    echo "  git commit --amend --no-edit"
    echo "  git push"
    echo ""
    exit 1
  fi
fi

# Check if version file exists for current version
VERSION_FILE="project/docs/changelog/v${CURRENT_VERSION}.md"
if [ ! -f "$VERSION_FILE" ] && grep -q "v${CURRENT_VERSION}" CHANGELOG.md 2>/dev/null; then
  echo "‚ö†Ô∏è  Warning: CHANGELOG.md mentions v${CURRENT_VERSION} but version file doesn't exist"
  echo "  Consider creating: $VERSION_FILE"
fi

echo "‚úÖ Changelog validation passed"
exit 0
